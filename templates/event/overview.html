{% extends "base.html" %}

{% block title %}{{event.__str__()}}{% endblock %}

{% block page_content %}
    <p>
        <strong>{{event.__str__()}}</strong>
        {% if event.end is none %}
            ist geplant aber hat noch keinen Termin.
        {% else %}
            {% if event.end < g.now %}fand{% else %}findet{% endif %}
            vom {{event.start | dmy_hm}} bis zum {{event.end | dmy_hm}}
            {% if event.location is not none %}
                {{event.location.prefix}}{{event.location}} statt.
            {% else %}
                statt. Der Ort steht noch nicht fest.
            {% endif %}
        {% endif %}
    </p>
    {% if event.orga_unassigned | length > 0 %}
        <p>Wir suchen noch Orga-Menschen für folgende Aufgaben: {{event.orga_unassigned | natjoin}}</p>
    {% endif %}
    <p>
        {% if event.signups | length > 0 %}
            {# Programmpunkte #}
            {% set num_programm = event.programm | selectattr('listed') | length %}
            {% if num_programm > 0 %}
                Aktuell {% if num_programm == 1 %}ist{% else %}sind{% endif %} <a href="{{(g.view_node / 'programm').url}}">{% if num_programm == 1 %}ein Programmpunkt{% else %}{{num_programm}} Programmpunkte{% endif %}</a> geplant und
            {% else %}
                Aktuell {% if event.signups | length == 1 %}ist{% else %}sind{% endif %}
            {% endif %}
            {# Menschen #}
            <a href="{{(g.view_node / 'mensch').url}}">{% if event.signups | length == 1 %}ein Mensch{% else %}{{event.signups | length}} Menschen{% endif %}</a> {% if num_programm > 1 and event.signups | length < 2 %}ist{% elif num_programm == 1 and event.signups | length > 1 %}sind{% endif %} angemeldet.
            {# freie Plätze #}
            {% if 'capacity' in event.location.data %}
                {% set capacity = event.location.data['capacity'].value() %}
                {% set naive_free = capacity - (event.signups | length) %}
                {% set free = event.free %}
                {% if free != naive_free %}
                    Weil {% if free - naive_free > 1 %}{{free - naive_free}} Paare von Menschen jeweils nicht gleichzeitig da sind{% else %}zwei Menschen nicht gleichzeitig da sind{% endif %}, sind aber erst {{capacity - free}} Plätze belegt.
                {% endif %}
                {% if free > 0 %}
                    Das Haus hat {{capacity}} Betten, es {% if free > 1 %}sind{% else %}ist{% endif %} also noch {{free}} Bett{% if free > 1 %}en{% endif %} frei.
                {% elif free == 0 %}
                    Damit ist das Haus exakt voll. Die Warteliste ist im Moment leer.
                {% else %}
                    Das Haus hat {{capacity}} Betten, es {% if free < -1 %}stehen{% else %}steht{% endif %} also {{(-free)}} Mensch{% if free < -1 %}en{% endif %} auf der Warteliste.
                {% endif %}
            {% endif %}
        {% else %}
            Aktuell ist noch niemand angemeldet.
        {% endif %}
    </p>
    {% if article_source is none %}
        <p>Eventbeschreibung coming soon™</p>
    {% else %}
        {{ article_source | markdown }}
    {% endif %}
    <h1 id="signup">Anmeldung</h1>
    {% if g.user in event.menschen %}
        <p>Du hast dich am {{event.attendee_data(g.user)['signup'] | dmy}} angemeldet.</p>
        <p>Du kannst <a href="{{(g.view_node / 'mensch' / g.user).url}}">deine Anmeldungsdaten</a> jederzeit <a href="{{(g.view_node / 'mensch' / g.user / 'edit').url}}">bearbeiten</a>. Einige Teile der Eventanmeldung sind noch in Arbeit (z.B. Zimmerverteilung). Wenn etwas Neues fertig ist, wirst du auf Discord angepingt.</p> {#TODO#}
        {% if event.guests | selectattr("via", "equalto", g.user) | length > 0 %}
            <h2>Gäste</h2>
            <ul>
                {% for guest in event.guests | selectattr("via", "equalto", g.user) %}
                    {% if guest in event.signups %}
                        <li><a href="{{(g.view_node / 'mensch' / guest).url}}">{{guest}}</a>: Anmeldung bestätigt</li>
                    {% else %}
                        <li>{{guest}}: noch nicht angemeldet</li> {#TODO link to event/guest-confirm.html #}
                    {% endif %}
                {% endfor %}
            </ul>
            {% if event.end > g.now or g.user.is_admin %}
                <p><a href="{{url_for('event_guest_form', event=event.event_id)}}">Weiteren Gast anmelden</a></p>
            {% endif %}
        {% elif event.end > g.now or g.user.is_admin %}
            <p><a href="{{url_for('event_guest_form', event=event.event_id)}}">Gast anmelden</a></p>
        {% endif %}
        {% if g.user.is_admin or event.attendee_data(g.user).get('orga', []) | length > 0 %}
            <h1 id="orga">Orga</h1>
            {% if g.user.is_admin or event.orga('Abrechnung') == g.user %}
                <h2>Abrechnung</h2>
                {% if event.orga('Abrechnung') is none %}
                    <p>Dieses Event hat noch keine Abrechnungsorga.</p>
                {% elif event.orga('Abrechnung').is_admin %}
                    <p>Dieses Event läuft über das Guthabensystem.</p>
                {% elif 'konto' in event.attendee_data(event.orga('Abrechnung')) %}
                    <p>Bitte überprüfe regelmäßig dein Konto {{event.attendee_data(g.user)['konto']['iban']}} auf Anzahlungen.</p>
                    {{gen_form(confirm_signup_form, g.view_node.url)}}
                {% else %}
                    <p>Um die Anmeldungen zu eröffnen, gib bitte {{g.admin}} deine Kontodaten.</p>
                {% endif %}
            {% endif %}
            {% if g.user.is_admin or event.orga('Buchung') == g.user %}
                <h2>Buchung</h2>
                {% if event.ausfall > event.anzahlung_total %}
                    <p>Wir können erst buchen, wenn die Ausfallgebühr von {{event.ausfall}} gesichert ist. Dazu fehlen noch {{event.ausfall - event.anzahlung_total}}, also {{((event.ausfall - event.anzahlung_total).value / event.anzahlung.value) | round(0, 'ceil') | int}} Anmeldungen.</p>
                {% else %}
                    <p>Die Ausfallgebühr von {{event.ausfall}} ist jetzt durch die Anzahlungen abgedeckt. Das Haus kann also gebucht werden.</p>
                {% endif %}
            {% endif %}
            {% if g.user.is_admin or event.orga('Essen') == g.user %}
                <h2>Essen</h2>
                <p>Trage bitte jeweils als Programmpunktbeschreibung ein, was es an dem Abend gibt.</p>
                <ul>
                    {% for date in event.nights %}
                        {% set date_info = event.essen(date) %}
                        <li>
                            <a href="{{url_for('event_programmpunkt', event=event.event_id, programmpunkt=date_info.name)}}">{{date | dm}}</a>:
                            {% if date_info.description == '' %}
                                noch nicht eingetragen
                            {% else %}
                                {{date_info.description}}
                            {% endif %}
                            (Orga: {% if date_info.orga is none %}noch nicht eingetragen{% else %}{{date_info.orga}}{% endif %})
                            — <a href="{{url_for('event_programmpunkt_edit', event=event.event_id, programmpunkt='abendessen{:%Y-%m-%d}'.format(date))}}">bearbeiten</a>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
            {% if g.user.is_admin or event.orga('Programm') == g.user %}
                <h2>Programm</h2>
                <h3>Programmpunkt erstellen</h3>
                {{gen_form(programm_add_form, g.view_node.url)}}
            {% endif %}
            {% if g.user.is_admin or event.orga('Schlüssel') == g.user %}
                <h2>Schlüssel</h2>
                <p>Coming soon™</p> {#TODO#}
            {% endif %}
        {% endif %}
    {% else %}
        {% if 'capacity' in event.location.data and event.free <= 0 %}
            <div class="alert alert-warning">
                <strong>Achtung:</strong> Das Haus ist schon voll. Du kannst dich trotzdem anmelden und kommst dann auf die Warteliste. Wenn jemand absagt, rückt der erste Mensch auf der Warteliste nach. {#TODO check for free nights, adjust message accordingly #}
                {% if event.anzahlung is none or event.anzahlung.value > 0 %}
                    Falls kein Platz für dich frei wird, bekommst du deine Anzahlung natürlich zurück.
                {% endif %}
            </div>
        {% endif %}
        {% if event.end < g.now %}
            <p>Dieses event ist schon vorbei.</p>
        {% elif event.orga('Abrechnung') is none %}
            <p>Das Orga-Team ist noch nicht vollständig, wir suchen noch jemanden für die Abrechnung. Wenn du das übernehmen möchtest, melde dich bitte bei {{g.admin}}.</p>
        {% elif event.anzahlung is none %}
            <p>{{event.orga('Abrechnung')}} hat die Höhe der Anzahlung noch nicht eingetragen.</p>
        {% elif event.anzahlung.value == 0 %}
            {{gen_form(profile_form, g.view_node.url)}}
        {% elif event.orga('Abrechnung') == g.admin %}
            <p>Die Anmeldung ist mit einer Anzahlung von {{event.anzahlung}} verbunden, die von deinem Guthaben abgezogen wird.</p>
            {% if g.user.is_admin or g.user.balance >= event.anzahlung %}
                {{gen_form(profile_form, g.view_node.url)}}
            {% else %}
                <p>Dein aktuelles Guthaben ist {{g.user.balance}}, es fehlen also noch {{event.anzahlung - g.user.balance}} für die Anzahlung. Auf <a href="{{url_for('profile', mensch=g.user.snowflake)}}">deiner Profilseite</a> steht, wie du Guthaben aufladen kannst.</p>
            {% endif %}
        {% else %}
            {% if 'konto' in event.attendee_data(event.orga('Abrechnung')) %}
                <p>Um dich anzumelden, überweise bitte die Anzahlung von {{event.anzahlung}} an:</p>
                <p>
                    {{event.attendee_data(event.orga('Abrechnung'))['konto']['name']}}<br />
                    IBAN: {{event.attendee_data(event.orga('Abrechnung'))['konto']['iban']}}<br />
                    BIC: {{event.attendee_data(event.orga('Abrechnung'))['konto']['bic']}}<br />
                    Verwendungszweck: Anzahlung {{event.event_id}} {{g.user.snowflake}}
                </p>
            {% else %}
                <p>Um dich anzumelden, gib bitte {{event.orga('Abrechnung')}} die Anzahlung von {{event.anzahlung}}.</p>
            {% endif %}
            <p>Details zu deiner Anmeldung kannst du eintragen, wenn die Anzahlung angekommen ist. Du wirst dazu auf Discord angepingt.</p> {#TODO reverse signup flow #}
        {% endif %}
    {% endif %}
{% endblock %}
