{% extends "base.html" %}

{% block title %}{{event}}{% endblock %}

{% block page_content %}
    <p><strong>{{event}}</strong> findet vom {{event.start | dmy_hm}} bis zum {{event.end | dmy_hm}} {{event.location.prefix}}{{event.location}} statt.</p>
    {% if event.signups | length > 0 %}
        <p>Aktuell {% if event.signups | length > 1 %}sind{% else %}ist{% endif %} <a href="{{url_for('event_menschen', event_id=event.event_id)}}">{{event.signups | length}} Mensch{% if event.signups | length > 1 %}en{% endif %}</a> angemeldet.</p>
    {% else %}
        <p>Aktuell ist noch niemand angemeldet.</p>
    {% endif %}
    <h1 id="signup">Anmeldung</h1>
    {% if g.user in event.menschen %}
        {% if event.anzahlung is none %}
            <p>Du bist schon angemeldet.</p>
        {% else %}
            <p>Deine Anzahlung von {{event.anzahlung}} ist am {{event.attendee_data(g.user)['signup'] | dmy}} angekommen. Damit bist du jetzt angemeldet.</p>
        {% endif %}
        <p>Der Rest der Anmeldungsseite ist noch in Arbeit. Wenn sie fertig ist, wirst du auf Discord angepingt.</p> {#TODO#}
        {% if event.guests | selectattr("via", "equalto", g.user) | length > 0 %}
            <h2>Gäste</h2>
            <ul>
                {% for guest in event.guests | selectattr("via", "equalto", g.user) %}
                    {% if guest in event.signups %}
                        <li>{{guest}}: Anmeldung bestätigt</li>
                    {% else %}
                        <li>{{guest}}: noch nicht angemeldet</li> {#TODO link to event-guest-confirm.html #}
                    {% endif %}
                {% endfor %}
            </ul>
            <p><a href="{{url_for('event_guest_form', event_id=event.event_id)}}">Weiteren Gast anmelden</a></p>
        {% else %}
            <p><a href="{{url_for('event_guest_form', event_id=event.event_id)}}">Gast anmelden</a></p>
        {% endif %}
        {% if event.attendee_data(g.user).get('orga', []) | length > 0 %}
            <h1 id="orga">Orga</h1>
            {% if event.orga('Abrechnung') == g.user %}
                <h2>Abrechnung</h2>
                {% if 'konto' in event.attendee_data(g.user) %}
                    <p>Bitte überprüfe regelmäßig dein Konto {{event.attendee_data(g.user)['konto']['iban']}} auf Anzahlungen.</p>
                    {{gen_form(confirm_signup_form, 'confirm-signup', 'Anzahlung bestätigen', url_for('event_page', event_id=event.event_id))}}
                {% else %}
                    <p>Um die Anmeldungen zu eröffnen, gib bitte {{config['web']['admin'] | mention}} deine Kontodaten.</p>
                {% endif %}
            {% endif %}
            {% if event.orga('Buchung') == g.user %}
                <h2>Buchung</h2>
                <p>coming soon™</p> {#TODO#}
            {% endif %}
            {% if event.orga('Essen') == g.user %}
                <h2>Essen</h2>
                <p>coming soon™</p> {#TODO#}
            {% endif %}
            {% if event.orga('Programm') == g.user %}
                <h2>Programm</h2>
                {% if event.data['programm'] | length > 0 %}
                    <ul>
                        {% for programmpunkt in event.data['programm'] %}
                            <li>{{programmpunkt.key}}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Noch keine Programmpunkte eingetragen.</p>
                {% endif %}
                <h3>Programmpunkt erstellen</h3>
                {{gen_form(programm_add_form, 'programm-add', 'Programmpunkt erstellen', url_for('event_page', event_id=event.event_id))}}
            {% endif %}
            {% if event.orga('Schlüssel') == g.user %}
                <h2>Schlüssel</h2>
                <p>coming soon™</p> {#TODO#}
            {% endif %}
        {% endif %}
    {% else %}
        {% if event.anzahlung is none %}
            <p>Coming soon™</p> {#TODO#}
        {% elif event.orga('Abrechnung') is none %}
            <p>Das Orga-Team ist noch nicht vollständig, wir suchen noch jemanden für die Abrechnung. Wenn du das übernehmen möchtest, melde dich bitte bei {{config['web']['admin'] | mention}}.</p>
        {% elif 'konto' not in event.attendee_data(event.orga('Abrechnung')) %}
            <p>{{event.orga('Abrechnung') | mention}} hat die Anmeldungen noch nicht eröffnet.</p>
        {% else %}
            <p>Um dich anzumelden, überweise bitte die Anzahlung von {{event.anzahlung}} an:</p>
            <p>
                {{event.attendee_data(event.orga('Abrechnung'))['konto']['name']}}<br />
                IBAN: {{event.attendee_data(event.orga('Abrechnung'))['konto']['iban']}}<br />
                BIC: {{event.attendee_data(event.orga('Abrechnung'))['konto']['bic']}}<br />
                Verwendungszweck: Anzahlung {{event.event_id}} {{g.user.snowflake}}
            </p>
            {% if event.ausfall.value > (event.signups | length) * event.anzahlung.value %}
                <p>Wichtig: wir können erst buchen, wenn die Ausfallgebühr von {{event.ausfall}} gesichert ist. Dazu fehlen noch {{(event.ausfall.value / event.anzahlung.value - (event.signups | length)) | round(0, 'ceil') | int}} Anmeldungen.</p>
            {% endif %}
        {% endif %}
    {% endif %}
{% endblock %}
